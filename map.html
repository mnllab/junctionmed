<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ—ºï¸</text></svg>">
  <title>Sales Network Map</title>
  <style>
    :root {
      --color-primary: #4f46e5;
      --color-primary-hover: #4338ca;
      --border-color: #e5e7eb;
      --background-light: #f9fafb;
      --text-main: #111827;
      --text-muted: #6b7280;
      --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px -1px rgba(0, 0, 0, 0.1);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
      --radius: 8px;
    }
    html, body { 
      height: 100%; 
      margin: 0; 
      font-family: 'Pretendard', system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans KR", Arial, sans-serif;
      background-color: #f9fafb;
      color: var(--text-main);
    }
    header { 
      padding: 12px 20px; 
      border-bottom: 1px solid var(--border-color); 
      display: flex; 
      gap: 16px; 
      align-items: center;
      background-color: #fff;
      box-shadow: var(--shadow);
      z-index: 10;
      position: relative;
    }
    header h1 { 
      font-size: 20px; 
      margin: 0; 
      font-weight: 700;
    }
    #main { 
      display: grid; 
      grid-template-columns: 340px 1fr; 
      height: calc(100% - 65px); 
    }
    #sidebar { 
      border-right: 1px solid var(--border-color); 
      padding: 16px; 
      overflow-y: auto; 
      background-color: #fff;
    }
    #map { height: 100%; }
    
    .pill { 
      display: inline-block; 
      padding: 4px 12px; 
      border-radius: 999px; 
      border: 1px solid var(--border-color); 
      background: var(--background-light);
      font-size: 13px;
      font-weight: 500;
    }
    
    input, select, button, textarea { 
      font: inherit; 
      transition: all 0.2s ease;
    }
    input[type="text"], input[type="url"], input[type="number"], input[type="password"], textarea, select { 
      width: 100%; 
      padding: 8px 12px; 
      border-radius: var(--radius); 
      border: 1px solid var(--border-color); 
      box-sizing: border-box;
      background-color: #fff;
    }
    input:focus, select:focus, textarea:focus {
      outline: 2px solid transparent;
      outline-offset: 2px;
      border-color: var(--color-primary);
      box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.3);
    }
    
    button { 
      padding: 8px 14px; 
      border-radius: var(--radius); 
      border: 1px solid var(--border-color); 
      background: #fff; 
      cursor: pointer; 
      font-weight: 600;
    }
    button:hover { 
      background: var(--background-light);
      border-color: #d1d5db;
    }
    button#loadBtn {
      background-color: var(--color-primary);
      color: #fff;
      border-color: var(--color-primary);
    }
    button#loadBtn:hover {
      background-color: var(--color-primary-hover);
    }
    
    details { 
      background: #fff; 
      border: 1px solid var(--border-color); 
      border-radius: var(--radius); 
      margin-bottom: 16px;
      overflow: hidden;
    }
    details[open] summary {
      border-bottom: 1px solid var(--border-color);
    }
    summary { 
      cursor: pointer;
      padding: 12px 14px;
      font-weight: 600;
      font-size: 15px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    summary::marker { content: ''; }
    summary:before {
      content: 'â–¶';
      font-size: 0.7em;
      transition: transform 0.2s;
      margin-right: 4px;
    }
    details[open] > summary:before {
      transform: rotate(90deg);
    }
    .details-content {
      padding: 16px;
    }

    .legend { background: #fff; padding: 12px; border-radius: var(--radius); box-shadow: var(--shadow-md); font-size: 13px; }
    .legend h3 { margin: 0 0 8px; font-size: 13px; font-weight: 700; }
    
    label { display: block; margin-bottom: 6px; font-size: 14px; font-weight: 500; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .mb8 { margin-bottom: 8px; }
    .mb12 { margin-bottom: 12px; }
    .mb16 { margin-bottom: 16px; }
    .muted { color: var(--text-muted); font-size: 12px; }
    .stat { display:flex; justify-content: space-between; margin: 8px 0; font-size: 14px; padding-bottom: 8px; border-bottom: 1px dashed var(--border-color); }
    .stat:last-child { border-bottom: 0; }
  </style>
</head>
<body>
  <header>
    <h1>ğŸ—ºï¸ ì˜ì—…ë§ ì§€ë„</h1>
    <span class="pill" id="countPill">ë°ì´í„°: 0ê°œ</span>
    <span class="pill" id="verPill"></span>
  </header>

  <div id="debugBanner" style="display:none;padding:10px 16px;background:#fee2e2;color:#991b1b;border-bottom:1px solid #fecaca;font-size:14px; display:flex; align-items:center; justify-content:space-between;">
    <span>ì§€ë„ ì´ˆê¸°í™”ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. API í‚¤ì™€ ì„¤ì •ì„ í™•ì¸í•´ì£¼ì„¸ìš”.</span> <button id="dbgToggle">ìƒì„¸ ë³´ê¸°</button>
  </div>
  <div id="debugPanel" style="display:none;padding:12px 16px;border-bottom:1px solid #eee;font-size:12px;line-height:1.6; background: #fff8f8;">
    <div><b>í˜„ì¬ Origin:</b> <span id="dbgOrigin"></span></div>
    <div><b>ì˜¤ë¥˜ ë¡œê·¸:</b></div>
    <pre id="dbgLog" style="white-space:pre-wrap;background:#fafafa;border:1px solid #eee;padding:8px;border-radius:6px;max-height:160px;overflow:auto"></pre>
    <div><b>ì²´í¬ë¦¬ìŠ¤íŠ¸</b></div>
    <ul style="margin:6px 0 0 18px; padding-left: 0;">
      <li>í‚¤ ì˜¤íƒ€ ì—¬ë¶€ (ê³µë°±/ë”°ì˜´í‘œ í¬í•¨ X)</li>
      <li>Maps JavaScript API <u>ì‚¬ìš© ì„¤ì •</u> ì—¬ë¶€</li>
      <li>ê²°ì œ ê³„ì • ì—°ê²° ì—¬ë¶€ (ì›” $200 ë¬´ë£Œ í¬ë ˆë”§)</li>
      <li>HTTP referrer ì œí•œì— <code id="dbgRef"></code> ë˜ëŠ” <code id="dbgRef2"></code> ì¶”ê°€</li>
      <li>ê´‘ê³ /ì¶”ì  ì°¨ë‹¨ í™•ì¥í”„ë¡œê·¸ë¨ ì¼ì‹œ ë¹„í™œì„±í™”</li>
      <li>HTTPSë¡œ ì ‘ì†, í˜¼í•©ì½˜í…ì¸  ì°¨ë‹¨ ì—¬ë¶€ í™•ì¸</li>
    </ul>
  </div>

  <div id="main">
    <aside id="sidebar">
      <details open>
        <summary>ğŸ“‚ ë°ì´í„° ì†ŒìŠ¤</summary>
        <div class="details-content">
          <div class="mb16">
            <label for="mode">ëª¨ë“œ</label>
            <select id="mode">
              <option value="url">A) ê³µê°œ CSV / gviz JSON URL</option>
              <option value="sheets">B) Google Sheets API</option>
            </select>
          </div>
          <div id="mode-url" class="mb12">
            <label for="sheetUrl">ì‹œíŠ¸ ê³µê°œ URL</label>
            <input id="sheetUrl" type="url" placeholder="ì˜ˆ: .../pub?output=csv" />
          </div>
          <div id="mode-sheets" class="mb12" style="display:none">
            <div class="mb8"><label for="sheetId">ì‹œíŠ¸ ID</label><input id="sheetId" type="text" placeholder="ë¬¸ì„œ URLì˜ /d/ì™€ /edit ì‚¬ì´ ID" /></div>
            <div class="mb8"><label for="sheetRange">ë²”ìœ„</label><input id="sheetRange" type="text" placeholder="ì˜ˆ: Sheet1!A1:J999" /></div>
            <div class="mb8"><label for="sheetsApiKey">Google API Key</label><input id="sheetsApiKey" type="password" placeholder="ë¸Œë¼ìš°ì € ë…¸ì¶œ ì£¼ì˜: ë„ë©”ì¸ ì œí•œ ê¶Œì¥" /></div>
            <div class="muted">â€» ì‹œíŠ¸ê°€ ë¹„ê³µê°œë©´ í´ë¼ì´ì–¸íŠ¸ì—ì„œ ì ‘ê·¼ ë¶ˆê°€í•©ë‹ˆë‹¤.</div>
          </div>
          <div class="mb16"><label for="geojsonUrl">GeoJSON URL (ì„ íƒ)</label><input id="geojsonUrl" type="url" placeholder="ê¶Œì—­ í´ë¦¬ê³¤ GeoJSON ì£¼ì†Œ" /></div>
          <div class="row mb8">
            <div><label for="refreshSec">ìë™ ìƒˆë¡œê³ ì¹¨(ì´ˆ)</label><input id="refreshSec" type="number" min="0" value="0" /></div>
            <div><label>&nbsp;</label><div style="display:flex;gap:6px"><button id="loadBtn">ë¶ˆëŸ¬ì˜¤ê¸°</button><button id="demoBtn" type="button">ë°ëª¨</button></div></div>
          </div>
        </div>
      </details>

      <details open>
        <summary>ğŸ¨ ê°•ë„(Count) ìƒ‰ìƒ</summary>
        <div class="details-content">
            <div class="row mb12">
            <div>
                <label for="thresholds">ê²½ê³„ê°’ (ì‰¼í‘œ êµ¬ë¶„)</label>
                <input id="thresholds" type="text" value="100,500,1000,2000" />
            </div>
            <div>
                <label for="palette">íŒ”ë ˆíŠ¸</label>
                <select id="palette">
                <option value="spectral">Spectral</option>
                <option value="viridis">Viridis</option>
                <option value="blues">Blues</option>
                <option value="reds">Reds</option>
                </select>
            </div>
            </div>
            <label style="display:flex; align-items:center; gap: 8px; user-select:none;"><input id="enableDensity" type="checkbox" checked /> `count` ê°’ì— ë”°ë¼ ìƒ‰ìƒ ì ìš©</label>
            <div id="legendBox" class="mb8" style="margin-top:16px;"></div>
        </div>
      </details>

      <details open>
        <summary>ğŸ” í•„í„°</summary>
        <div class="details-content">
            <div class="mb12"><label for="fName">ì´ë¦„ í¬í•¨</label><input id="fName" type="text" placeholder="ì˜ˆ: ì„œìš¸, ë¶€ì‚°" /></div>
            <div class="row mb12">
            <div><label for="fMin">count â‰¥</label><input id="fMin" type="number" placeholder="ìµœì†Œ" /></div>
            <div><label for="fMax">count â‰¤</label><input id="fMax" type="number" placeholder="ìµœëŒ€" /></div>
            </div>
            <label class="mb16" style="display:flex; align-items:center; gap: 8px; user-select:none;"><input id="fHideNaN" type="checkbox" /> `count` ì—†ëŠ” í–‰ ìˆ¨ê¸°ê¸°</label>
            <button id="applyFilter">í•„í„° ì ìš©</button>
        </div>
      </details>

      <details open>
        <summary>ğŸ“Š ì§‘ê³„</summary>
        <div class="details-content">
            <div id="stats"></div>
        </div>
      </details>
    </aside>

    <div id="map" role="region" aria-label="ì˜ì—…ë§ ì§€ë„"></div>
  </div>
  
  <script>
    // All previous JavaScript code remains the same...
    // ...
    // (ì´ì „ì˜ ëª¨ë“  JavaScript ì½”ë“œëŠ” ê·¸ëŒ€ë¡œ ìœ ì§€ë©ë‹ˆë‹¤)
  </script>
  
  <script>
    // Debug script remains the same...
    // ...
  </script>

  <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCJKF6l-C4shNQbO99oImE6D_69JL7ZnnE&callback=initMap&libraries=maps,marker&v=weekly"></script>
</body>
</html>
