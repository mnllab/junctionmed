<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>🗺️</text></svg>">
  <title>Sales Network Map</title>
  <style>
    :root {
      --color-primary: #4f46e5;
      --color-primary-hover: #4338ca;
      --border-color: #e5e7eb;
      --background-light: #f9fafb;
      --text-main: #111827;
      --text-muted: #6b7280;
      --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px -1px rgba(0, 0, 0, 0.1);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
      --radius: 8px;
    }
    html, body {
      height: 100%;
      margin: 0;
      font-family: 'Pretendard', system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans KR", Arial, sans-serif;
      background-color: #f9fafb;
      color: var(--text-main);
    }
    header {
      padding: 12px 20px;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      gap: 16px;
      align-items: center;
      background-color: #fff;
      box-shadow: var(--shadow);
      z-index: 10;
      position: relative;
    }
    header h1 {
      font-size: 20px;
      margin: 0;
      font-weight: 700;
    }
    #main {
      display: grid;
      grid-template-columns: 340px 1fr;
      height: calc(100% - 65px);
    }
    #sidebar {
      border-right: 1px solid var(--border-color);
      padding: 16px;
      overflow-y: auto;
      background-color: #fff;
    }
    #map { height: 100%; }

    .pill {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 999px;
      border: 1px solid var(--border-color);
      background: var(--background-light);
      font-size: 13px;
      font-weight: 500;
    }

    input, select, button, textarea {
      font: inherit;
      transition: all 0.2s ease;
    }
    input[type="text"], input[type="url"], input[type="number"], input[type="password"], textarea, select {
      width: 100%;
      padding: 8px 12px;
      border-radius: var(--radius);
      border: 1px solid var(--border-color);
      box-sizing: border-box;
      background-color: #fff;
    }
    input:focus, select:focus, textarea:focus {
      outline: 2px solid transparent;
      outline-offset: 2px;
      border-color: var(--color-primary);
      box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.3);
    }

    button {
      padding: 8px 14px;
      border-radius: var(--radius);
      border: 1px solid var(--border-color);
      background: #fff;
      cursor: pointer;
      font-weight: 600;
    }
    button:hover {
      background: var(--background-light);
      border-color: #d1d5db;
    }
    button#loadBtn {
      background-color: var(--color-primary);
      color: #fff;
      border-color: var(--color-primary);
    }
    button#loadBtn:hover {
      background-color: var(--color-primary-hover);
    }

    details {
      background: #fff;
      border: 1px solid var(--border-color);
      border-radius: var(--radius);
      margin-bottom: 16px;
      overflow: hidden;
    }
    details[open] summary {
      border-bottom: 1px solid var(--border-color);
    }
    summary {
      cursor: pointer;
      padding: 12px 14px;
      font-weight: 600;
      font-size: 15px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    summary::marker { content: ''; }
    summary:before {
      content: '▶';
      font-size: 0.7em;
      transition: transform 0.2s;
      margin-right: 4px;
    }
    details[open] > summary:before {
      transform: rotate(90deg);
    }
    .details-content {
      padding: 16px;
    }

    .legend { background: #fff; padding: 12px; border-radius: var(--radius); box-shadow: var(--shadow-md); font-size: 13px; }
    .legend h3 { margin: 0 0 8px; font-size: 13px; font-weight: 700; }

    label { display: block; margin-bottom: 6px; font-size: 14px; font-weight: 500; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .mb8 { margin-bottom: 8px; }
    .mb12 { margin-bottom: 12px; }
    .mb16 { margin-bottom: 16px; }
    .muted { color: var(--text-muted); font-size: 12px; }
    .stat { display:flex; justify-content: space-between; margin: 8px 0; font-size: 14px; padding-bottom: 8px; border-bottom: 1px dashed var(--border-color); }
    .stat:last-child { border-bottom: 0; }
  </style>
</head>
<body>
  <header>
    <h1>🗺️ 영업망 지도</h1>
    <span class="pill" id="countPill">데이터: 0개</span>
    <span class="pill" id="verPill"></span>
  </header>

  <div id="debugBanner" style="display:none;padding:10px 16px;background:#fee2e2;color:#991b1b;border-bottom:1px solid #fecaca;font-size:14px; display:flex; align-items:center; justify-content:space-between;">
    <span>지도 초기화에 실패했습니다. API 키와 설정을 확인해주세요.</span> <button id="dbgToggle">상세 보기</button>
  </div>
  <div id="debugPanel" style="display:none;padding:12px 16px;border-bottom:1px solid #eee;font-size:12px;line-height:1.6; background: #fff8f8;">
    <div><b>현재 Origin:</b> <span id="dbgOrigin"></span></div>
    <div><b>오류 로그:</b></div>
    <pre id="dbgLog" style="white-space:pre-wrap;background:#fafafa;border:1px solid #eee;padding:8px;border-radius:6px;max-height:160px;overflow:auto"></pre>
    <div><b>체크리스트</b></div>
    <ul style="margin:6px 0 0 18px; padding-left: 0;">
      <li>키 오타 여부 (공백/따옴표 포함 X)</li>
      <li>Maps JavaScript API <u>사용 설정</u> 여부</li>
      <li>결제 계정 연결 여부 (월 $200 무료 크레딧)</li>
      <li>HTTP referrer 제한에 <code id="dbgRef"></code> 또는 <code id="dbgRef2"></code> 추가</li>
      <li>광고/추적 차단 확장프로그램 일시 비활성화</li>
      <li>HTTPS로 접속, 혼합콘텐츠 차단 여부 확인</li>
    </ul>
  </div>

  <div id="main">
    <aside id="sidebar">
      <details open>
        <summary>📂 데이터 소스</summary>
        <div class="details-content">
          <div class="mb16">
            <label for="mode">모드</label>
            <select id="mode">
              <option value="url">A) 공개 CSV / gviz JSON URL</option>
              <option value="sheets">B) Google Sheets API</option>
            </select>
          </div>
          <div id="mode-url" class="mb12">
            <label for="sheetUrl">시트 공개 URL</label>
            <input id="sheetUrl" type="url" placeholder="예: .../pub?output=csv" />
          </div>
          <div id="mode-sheets" class="mb12" style="display:none">
            <div class="mb8"><label for="sheetId">시트 ID</label><input id="sheetId" type="text" placeholder="문서 URL의 /d/와 /edit 사이 ID" /></div>
            <div class="mb8"><label for="sheetRange">범위</label><input id="sheetRange" type="text" placeholder="예: Sheet1!A1:J999" /></div>
            <div class="mb8"><label for="sheetsApiKey">Google API Key</label><input id="sheetsApiKey" type="password" placeholder="브라우저 노출 주의: 도메인 제한 권장" /></div>
            <div class="muted">※ 시트가 비공개면 클라이언트에서 접근 불가합니다.</div>
          </div>
          <div class="mb16"><label for="geojsonUrl">GeoJSON URL (선택)</label><input id="geojsonUrl" type="url" placeholder="권역 폴리곤 GeoJSON 주소" /></div>
          <div class="row mb8">
            <div><label for="refreshSec">자동 새로고침(초)</label><input id="refreshSec" type="number" min="0" value="0" /></div>
            <div><label>&nbsp;</label><div style="display:flex;gap:6px"><button id="loadBtn">불러오기</button><button id="demoBtn" type="button">데모</button></div></div>
          </div>
        </div>
      </details>

      <details open>
        <summary>🎨 강도(Count) 색상</summary>
        <div class="details-content">
            <div class="row mb12">
            <div>
                <label for="thresholds">경계값 (쉼표 구분)</label>
                <input id="thresholds" type="text" value="100,500,1000,2000" />
            </div>
            <div>
                <label for="palette">팔레트</label>
                <select id="palette">
                <option value="spectral">Spectral</option>
                <option value="viridis">Viridis</option>
                <option value="blues">Blues</option>
                <option value="reds">Reds</option>
                </select>
            </div>
            </div>
            <label style="display:flex; align-items:center; gap: 8px; user-select:none;"><input id="enableDensity" type="checkbox" checked /> `count` 값에 따라 색상 적용</label>
            <div id="legendBox" class="mb8" style="margin-top:16px;"></div>
        </div>
      </details>

      <details open>
        <summary>🔍 필터</summary>
        <div class="details-content">
            <div class="mb12"><label for="fName">이름 포함</label><input id="fName" type="text" placeholder="예: 서울, 부산" /></div>
            <div class="row mb12">
            <div><label for="fMin">count ≥</label><input id="fMin" type="number" placeholder="최소" /></div>
            <div><label for="fMax">count ≤</label><input id="fMax" type="number" placeholder="최대" /></div>
            </div>
            <label class="mb16" style="display:flex; align-items:center; gap: 8px; user-select:none;"><input id="fHideNaN" type="checkbox" /> `count` 없는 행 숨기기</label>
            <button id="applyFilter">필터 적용</button>
        </div>
      </details>

      <details open>
        <summary>📊 집계</summary>
        <div class="details-content">
            <div id="stats"></div>
        </div>
      </details>
    </aside>

    <div id="map" role="region" aria-label="영업망 지도"></div>
  </div>

  <script>
    // 전역 변수
    let map, infoWindow, circles = [], lastItems = [], polygons = [];
    let refreshTimer = null;

    // 기본 설정
    const DEFAULT_CENTER = { lat: 36.5, lng: 127.8 };
    const DEFAULT_ZOOM = 7;
    const APP_VERSION = 'v1.5.1';
    const BUILD_DATE = '2025-09-07';

    // 유틸리티 함수들
    function escapeHtml(s) {
      return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\"/g,'&quot;').replace(/'/g,'&#039;');
    }

    function coerceNumber(v) {
      if (v == null) return NaN;
      if (typeof v === 'number') return v;
      const n = parseFloat(String(v).replace(/,/g, ''));
      return isNaN(n) ? NaN : n;
    }

    function pickColor(i) {
      const colors = ['#4f46e5', '#16a34a', '#f59e0b', '#ef4444', '#8b5cf6', '#0ea5e9', '#22c55e', '#d946ef'];
      return colors[i % colors.length];
    }

    // CSV 파서
    function parseCSV(text) {
        const rows = [];
        let i = 0, cur = '', row = [], inQuotes = false;
        text = text.replace(/\r\n/g, '\n').replace(/\r/g, '\n');

        while (i < text.length) {
            const ch = text[i];
            if (inQuotes) {
                if (ch === '"') {
                    if (text[i + 1] === '"') { cur += '"'; i++; }
                    else { inQuotes = false; }
                } else { cur += ch; }
            } else {
                if (ch === '"') { inQuotes = true; }
                else if (ch === ',') { row.push(cur.trim()); cur = ''; }
                else if (ch === '\n') {
                    if (cur !== '' || row.length) {
                        row.push(cur.trim());
                        rows.push(row);
                        row = [];
                        cur = '';
                    }
                } else { cur += ch; }
            }
            i++;
        }
        if (cur !== '' || row.length) { row.push(cur.trim()); rows.push(row); }
        if (!rows.length) throw new Error('CSV 내용이 비어있습니다.');
        const header = rows.shift().map(h => h.trim());
        return { cols: header, rows };
    }

    // gviz 파서
    function parseGviz(raw) {
      const s = raw.indexOf('(');
      const e = raw.lastIndexOf(')');
      if (s === -1 || e === -1) throw new Error('gviz 응답 형식 오류');
      const obj = JSON.parse(raw.slice(s + 1, e));
      const cols = obj.table.cols.map(c => c.label || c.id || '');
      const rows = obj.table.rows.map(r => r.c.map(c => c ? c.v : ''));
      return { cols, rows };
    }

    function getThresholds() {
      return (document.getElementById('thresholds').value || '')
        .split(',')
        .map(s => parseFloat(s.trim()))
        .filter(n => Number.isFinite(n))
        .sort((a, b) => a - b);
    }

    function getBin(v, ths) {
      for (let i = 0; i < ths.length; i++) {
        if (v < ths[i]) return i;
      }
      return ths.length;
    }

    function getPalette(n) {
      const maps = {
        spectral: ['#9e0142', '#d53e4f', '#f46d43', '#fdae61', '#fee08b', '#e6f598', '#abdda4', '#66c2a5', '#3288bd', '#5e4fa2'],
        viridis: ['#440154', '#482475', '#414487', '#355f8d', '#2a788e', '#21918c', '#22a884', '#44bf70', '#7ad151', '#fde725'],
        blues: ['#eff3ff', '#c6dbef', '#9ecae1', '#6baed6', '#4292c6', '#2171b5', '#084594'],
        reds: ['#fee5d9', '#fcbba1', '#fc9272', '#fb6a4a', '#ef3b2c', '#cb181d', '#99000d']
      };
      const key = document.getElementById('palette').value || 'spectral';
      const base = maps[key];
      if (n <= base.length) return base.slice(0, n);
      const out = [];
      for (let i = 0; i < n; i++) {
        const idx = Math.round(i * (base.length - 1) / (n - 1));
        out.push(base[idx]);
      }
      return out;
    }

    function initMap() {
      // 지도 초기화 성공 시, 불필요한 디버그 배너를 숨깁니다.
      document.getElementById('debugBanner').style.display = 'none';
      try {
        map = new google.maps.Map(document.getElementById('map'), {
          center: DEFAULT_CENTER,
          zoom: DEFAULT_ZOOM,
          mapTypeControl: false,
          streetViewControl: false,
          fullscreenControl: false,
          styles: [ /* Optional: Add map styles for a more custom look */ ]
        });
        infoWindow = new google.maps.InfoWindow();

        document.getElementById('mode').addEventListener('change', onModeChange);
        document.getElementById('loadBtn').addEventListener('click', () => {
          loadAll();
          setupAutoRefresh();
        });
        document.getElementById('demoBtn').addEventListener('click', loadDemoData);
        document.getElementById('applyFilter').addEventListener('click', () => {
          renderCircles(filterItems(lastItems));
        });
        ['thresholds', 'palette', 'enableDensity'].forEach(id => {
          document.getElementById(id).addEventListener('change', () => {
            renderCircles(filterItems(lastItems));
          });
        });

        onModeChange();
        loadDemoData();

      } catch (e) {
        console.error('지도 초기화 오류:', e);
        // 진짜 오류 발생 시 다시 배너를 표시할 수 있습니다.
        document.getElementById('debugBanner').style.display = 'flex';
        throw e;
      }
    }

    function onModeChange() {
      const m = document.getElementById('mode').value;
      document.getElementById('mode-url').style.display = (m === 'url') ? 'block' : 'none';
      document.getElementById('mode-sheets').style.display = (m === 'sheets') ? 'block' : 'none';
    }

    function setupAutoRefresh() {
      const sec = parseInt(document.getElementById('refreshSec').value || '0', 10);
      if (refreshTimer) { clearInterval(refreshTimer); refreshTimer = null; }
      if (sec > 0) { refreshTimer = setInterval(loadAll, sec * 1000); }
    }

    async function loadAll() {
      try {
        const items = await loadPointItems();
        lastItems = items;
        const geoUrl = document.getElementById('geojsonUrl').value.trim();
        if (geoUrl) { await loadPolygons(geoUrl); }
        renderCircles(filterItems(items));
      } catch (e) {
        console.error(e);
        alert('데이터 불러오기 실패: ' + (e?.message || e));
      }
    }

    function loadDemoData() {
        const csv = `name,lat,lng,radius_km,count,color,stroke_color,stroke_opacity,fill_opacity,note
서울본부,37.5665,126.978,25,2450,#4f46e5,#4f46e5,0.9,0.2,수도권 총괄본부
부산지사,35.1796,129.0756,20,1320,#16a34a,#16a34a,0.9,0.2,영남권 관리지사
대구센터,35.8714,128.6014,18,850,#f59e0b,#f59e0b,0.9,0.18,대구경북 담당
인천지점,37.4563,126.7052,15,680,#ef4444,#ef4444,0.9,0.18,인천경기서부
광주본부,35.1595,126.8526,22,920,#8b5cf6,#8b5cf6,0.9,0.2,호남권 총괄
원주센터,37.3422,127.9202,12,420,#0ea5e9,#0ea5e9,0.8,0.15,강원도 원주권역
대전센터,36.3504,127.3845,16,750,#d946ef,#d946ef,0.9,0.18,충청권 중심`;
      try {
        const table = parseCSV(csv);
        const items = processTableData(table);
        lastItems = items;
        renderCircles(filterItems(items));
      } catch (e) {
        console.error(e);
        alert('데모 데이터 로드 실패: ' + (e?.message || e));
      }
    }

    async function loadPointItems() {
      const mode = document.getElementById('mode').value;
      let table;
      if (mode === 'url') {
        const url = document.getElementById('sheetUrl').value.trim();
        if (!url) throw new Error('시트 공개 URL을 입력하세요');
        const text = await (await fetch(url)).text();
        table = url.includes('/gviz/tq') ? parseGviz(text) : parseCSV(text);
      } else {
        const id = document.getElementById('sheetId').value.trim();
        const range = encodeURIComponent(document.getElementById('sheetRange').value.trim());
        const key = document.getElementById('sheetsApiKey').value.trim();
        if (!id || !range || !key) throw new Error('시트ID, 범위, API Key를 입력하세요');
        const url = `https://sheets.googleapis.com/v4/spreadsheets/${id}/values/${range}?key=${key}`;
        const json = await (await fetch(url)).json();
        if (json.error) throw new Error(`Sheets API 오류: ${json.error.message}`);
        if (!json.values || !json.values.length) throw new Error('시트에 데이터가 없습니다');
        const cols = json.values[0];
        const rows = json.values.slice(1);
        table = { cols, rows };
      }
      return processTableData(table);
    }

    function processTableData(table) {
      const idx = {};
      const names = table.cols.map(c => String(c).trim().toLowerCase());
      ['name', 'lat', 'lng', 'radius_km', 'count', 'color', 'stroke_color', 'stroke_opacity', 'fill_opacity', 'note']
        .forEach(k => idx[k] = names.indexOf(k));
      return table.rows.map((r, i) => {
        const name = idx.name >= 0 ? r[idx.name] : `지점 ${i + 1}`;
        return {
          name: name,
          lat: coerceNumber(r[idx.lat]),
          lng: coerceNumber(r[idx.lng]),
          radius_km: coerceNumber(r[idx.radius_km]),
          count: idx.count >= 0 ? coerceNumber(r[idx.count]) : NaN,
          color: (idx.color >= 0 && r[idx.color]) ? r[idx.color] : pickColor(i),
          strokeColor: (idx.stroke_color >= 0 && r[idx.stroke_color]) ? r[idx.stroke_color] : pickColor(i),
          strokeOpacity: (idx.stroke_opacity >= 0 && r[idx.stroke_opacity]) ? Number(r[idx.stroke_opacity]) : 0.9,
          fillOpacity: (idx.fill_opacity >= 0 && r[idx.fill_opacity]) ? Number(r[idx.fill_opacity]) : 0.2,
          note: (idx.note >= 0 && r[idx.note]) ? r[idx.note] : ''
        };
      }).filter(it => Number.isFinite(it.lat) && Number.isFinite(it.lng) && Number.isFinite(it.radius_km));
    }

    function filterItems(items) {
      if (!items || !items.length) return [];
      const q = (document.getElementById('fName').value || '').trim();
      const min = parseFloat(document.getElementById('fMin').value);
      const max = parseFloat(document.getElementById('fMax').value);
      const hideNaN = document.getElementById('fHideNaN').checked;
      return items.filter(it => {
        if (q && !it.name.includes(q)) return false;
        if (Number.isFinite(min) && !(Number.isFinite(it.count) && it.count >= min)) return false;
        if (Number.isFinite(max) && !(Number.isFinite(it.count) && it.count <= max)) return false;
        if (hideNaN && !Number.isFinite(it.count)) return false;
        return true;
      });
    }

    async function loadPolygons(url) {
        try {
            const res = await fetch(url);
            if (!res.ok) throw new Error(`HTTP error! status: ${res.status}`);
            const gj = await res.json();
            polygons.forEach(p => p.setMap(null));
            polygons = [];
            const ths = getThresholds();
            const pal = getPalette(ths.length + 1);
            const densityOn = document.getElementById('enableDensity').checked;
            gj.features?.forEach((f, i) => {
                const props = f.properties || {};
                const val = coerceNumber(props.region_count);
                const fill = (densityOn && Number.isFinite(val)) ? pal[getBin(val, ths)] : '#6b7280';
                const poly = new google.maps.Data();
                poly.addGeoJson({ type: 'FeatureCollection', features: [f] });
                poly.setStyle({
                    fillColor: fill, fillOpacity: 0.1, strokeColor: fill,
                    strokeOpacity: 0.6, strokeWeight: 1.5
                });
                poly.setMap(map);
                poly.addListener('click', (e) => {
                    const center = e.latLng || map.getCenter();
                    const html = `<div style="min-width:240px; font-size:14px; line-height:1.6;">
                      <div style="font-weight:700;margin-bottom:6px; font-size:16px;">${escapeHtml(props.name || `폴리곤 ${i + 1}`)}</div>
                      ${Number.isFinite(val) ? `<div><b>Region Count:</b> ${val.toLocaleString()}</div>` : ''}
                    </div>`;
                    infoWindow.setContent(html);
                    infoWindow.setPosition(center);
                    infoWindow.open({ map });
                });
                polygons.push(poly);
            });
        } catch (e) {
            console.warn('GeoJSON 로드 실패:', e.message);
        }
    }

    function renderCircles(items) {
      circles.forEach(c => c.setMap(null));
      circles = [];
      const bounds = new google.maps.LatLngBounds();
      const ths = getThresholds();
      const pal = getPalette(ths.length + 1);
      const densityOn = document.getElementById('enableDensity').checked;

      items.forEach((it) => {
        const center = { lat: it.lat, lng: it.lng };
        const isCountFinite = Number.isFinite(it.count);
        const fillColor = (densityOn && isCountFinite) ? pal[getBin(it.count, ths)] : it.color;
        const strokeColor = (densityOn && isCountFinite) ? fillColor : it.strokeColor;
        const circle = new google.maps.Circle({
          map, center, radius: it.radius_km * 1000,
          strokeColor, strokeOpacity: it.strokeOpacity, strokeWeight: 2,
          fillColor, fillOpacity: it.fillOpacity
        });
        circles.push(circle);
        bounds.extend(center);
        circle.addListener('click', () => {
          const html = `<div style="min-width:260px; font-size:14px; line-height:1.6;">
            <div style="font-weight:700;margin-bottom:6px; font-size:16px;">${escapeHtml(it.name)}</div>
            <div><b>위치:</b> ${it.lat.toFixed(4)}, ${it.lng.toFixed(4)}</div>
            <div><b>반경:</b> ${it.radius_km} km</div>
            ${isCountFinite ? `<div><b>도입 구좌수(count):</b> ${it.count.toLocaleString()}</div>` : ''}
            ${it.note ? `<div style="margin-top:8px; padding-top:8px; border-top:1px solid #eee;">${escapeHtml(it.note)}</div>` : ''}
          </div>`;
          infoWindow.setContent(html);
          infoWindow.setPosition(center);
          infoWindow.open({ map });
        });
      });

      if (items.length > 0 && !bounds.isEmpty()) map.fitBounds(bounds);

      document.getElementById('countPill').textContent = `데이터: ${items.length}개`;
      renderLegend(ths, pal);
      renderStats(items, ths);
    }

    function renderLegend(ths, pal) {
      const el = document.getElementById('legendBox');
      const blocks = [];
      if (!document.getElementById('enableDensity').checked) {
        el.innerHTML = '';
        return;
      }
      if (ths.length === 0) {
        blocks.push({ label: '모든 값', color: pal[0] });
      } else {
        for (let i = 0; i <= ths.length; i++) {
          let label = '';
          if (i === 0) label = `< ${ths[0].toLocaleString()}`;
          else if (i === ths.length) label = `≥ ${ths[i - 1].toLocaleString()}`;
          else label = `${ths[i - 1].toLocaleString()} – ${ths[i] - 1}`;
          blocks.push({ label, color: pal[i] });
        }
      }
      el.innerHTML = '<div class="legend"><h3>강도 스케일 (Count)</h3>' +
        blocks.map(b => `<div style="display:flex;align-items:center;gap:8px;margin:6px 0">
          <span style="display:inline-block;width:16px;height:16px;border-radius:4px;background:${b.color};border:1px solid rgba(0,0,0,.2)"></span>
          <span>${b.label}</span>
        </div>`).join('') + '</div>';
    }

    function renderStats(items, ths) {
      const el = document.getElementById('stats');
      const total = items.length;
      const sum = items.reduce((a, b) => a + (Number.isFinite(b.count) ? b.count : 0), 0);
      const bins = new Array(ths.length + 1).fill(0);
      items.forEach(it => {
        if (Number.isFinite(it.count)) bins[getBin(it.count, ths)]++;
      });

      let html = `<div class="stat"><span>총 지점 수</span><b>${total.toLocaleString()}</b></div>
                  <div class="stat"><span>Count 합계</span><b>${sum.toLocaleString()}</b></div>`;

      if (document.getElementById('enableDensity').checked && ths.length > 0) {
          html += '<div style="height:10px;"></div>';
          for (let i = 0; i < bins.length; i++) {
              let label = '';
              if (i === 0) label = `< ${ths[0].toLocaleString()}`;
              else if (i === bins.length - 1) label = `≥ ${ths[i - 1].toLocaleString()}`;
              else label = `${ths[i - 1].toLocaleString()} – ${ths[i] - 1}`;
              html += `<div class="stat"><span>${label}</span><b>${bins[i].toLocaleString()}</b></div>`;
          }
      }
      el.innerHTML = html;
    }

    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('verPill').textContent = `v${APP_VERSION}`;
    });

    window.initMap = initMap;
  </script>

  <script>
    // 디버그 스크립트
    (function() {
      const banner = document.getElementById('debugBanner');
      const panel = document.getElementById('debugPanel');
      const logEl = document.getElementById('dbgLog');
      if (document.getElementById('dbgOrigin')) document.getElementById('dbgOrigin').textContent = location.origin;
      if (document.getElementById('dbgRef')) document.getElementById('dbgRef').textContent = location.origin.replace(/\/$/, '') + '/*';
      if (document.getElementById('dbgRef2')) document.getElementById('dbgRef2').textContent = location.protocol + '//' + location.host + '/*';

      let inited = false;
      const oldInit = window.initMap;
      window.initMap = function() { inited = true; if (oldInit) oldInit(); };

      // 15초 내 initMap 미호출 시 배너 노출
      setTimeout(() => {
        if (!inited) {
            if (banner) banner.style.display = 'flex';
        }
      }, 15000);

      document.getElementById('dbgToggle').addEventListener('click', () => {
        if (panel) panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
      });

      const log = (m) => { if (logEl) logEl.textContent += (m + '\n'); };
      window.addEventListener('error', e => { log('[Error] ' + (e.message || e.type)); if (banner) banner.style.display = 'flex'; });
      window.addEventListener('unhandledrejection', e => { log('[Promise] ' + (e.reason && e.reason.message)); if (banner) banner.style.display = 'flex'; });
    })();
  </script>

  <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCJKF6l-C4shNQbO99oImE6D_69JL7ZnnE&callback=initMap&libraries=maps,marker&v=weekly"></script>
</body>
</html>

