<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>🗺️</text></svg>">
  <title>데이터 지도 시각화 도구</title>
  <style>
    :root {
      --color-primary: #4f46e5;
      --color-primary-hover: #4338ca;
      --border-color: #e5e7eb;
      --background-light: #f9fafb;
      --text-main: #111827;
      --text-muted: #6b7280;
      --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px -1px rgba(0, 0, 0, 0.1);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
      --radius: 8px;
    }
    html, body {
      height: 100%;
      margin: 0;
      font-family: 'Pretendard', system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans KR", Arial, sans-serif;
      background-color: #f9fafb;
      color: var(--text-main);
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    header {
      padding: 12px 20px;
      border-bottom: 1px solid var(--border-color);
      display: flex;
      gap: 16px;
      align-items: center;
      background-color: #fff;
      box-shadow: var(--shadow);
      z-index: 10;
      position: relative;
    }
    header h1 {
      font-size: 20px;
      margin: 0;
      font-weight: 700;
    }
    #main {
      display: grid;
      grid-template-columns: 360px 1fr;
      height: calc(100% - 65px);
    }
    #sidebar {
      border-right: 1px solid var(--border-color);
      padding: 16px;
      overflow-y: auto;
      background-color: #fff;
      transition: transform 0.3s ease-in-out;
    }
    #map { height: 100%; }

    .pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 12px;
      border-radius: 999px;
      border: 1px solid var(--border-color);
      background: var(--background-light);
      font-size: 13px;
      font-weight: 500;
    }

    input, select, button, textarea {
      font: inherit;
      transition: all 0.2s ease;
    }
    input[type="text"], input[type="url"], input[type="number"], input[type="password"], textarea, select {
      width: 100%;
      padding: 8px 12px;
      border-radius: var(--radius);
      border: 1px solid var(--border-color);
      box-sizing: border-box;
      background-color: #fff;
    }
    input:focus, select:focus, textarea:focus {
      outline: 2px solid transparent;
      outline-offset: 2px;
      border-color: var(--color-primary);
      box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.3);
    }

    button {
      padding: 9px 15px;
      border-radius: var(--radius);
      border: 1px solid var(--border-color);
      background: #fff;
      cursor: pointer;
      font-weight: 600;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }
    button:hover {
      background: var(--background-light);
      border-color: #d1d5db;
      transform: translateY(-1px);
    }
    button#loadBtn {
      background-color: var(--color-primary);
      color: #fff;
      border-color: var(--color-primary);
    }
    button#loadBtn:hover {
      background-color: var(--color-primary-hover);
    }

    details {
      background: #fff;
      border: 1px solid var(--border-color);
      border-radius: var(--radius);
      margin-bottom: 16px;
      overflow: hidden;
    }
    details[open] summary {
      border-bottom: 1px solid var(--border-color);
    }
    summary {
      cursor: pointer;
      padding: 12px 14px;
      font-weight: 600;
      font-size: 15px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    summary::marker { content: ''; }
    summary:before {
      content: '▶';
      font-size: 0.7em;
      transition: transform 0.2s;
      margin-right: 4px;
    }
    details[open] > summary:before {
      transform: rotate(90deg);
    }
    .details-content {
      padding: 16px;
    }

    .legend { background: #fff; padding: 12px; border-radius: var(--radius); box-shadow: var(--shadow-md); font-size: 13px; }
    .legend h3 { margin: 0 0 8px; font-size: 13px; font-weight: 700; }

    label { display: block; margin-bottom: 6px; font-size: 14px; font-weight: 500; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .muted { color: var(--text-muted); font-size: 12px; }
    .stat { display:flex; justify-content: space-between; margin: 8px 0; font-size: 14px; padding-bottom: 8px; border-bottom: 1px dashed var(--border-color); }
    .stat:last-child { border-bottom: 0; }

    #loader {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(255, 255, 255, 0.7);
      z-index: 100;
      display: flex;
      align-items: center;
      justify-content: center;
      backdrop-filter: blur(4px);
    }
    .spinner {
      width: 56px;
      height: 56px;
      border: 7px solid var(--border-color);
      border-bottom-color: var(--color-primary);
      border-radius: 50%;
      display: inline-block;
      box-sizing: border-box;
      animation: rotation 1s linear infinite;
    }
    @keyframes rotation {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    #backdrop {
      position: fixed;
      top: 0; left: 0;
      width: 100%; height: 100%;
      background: rgba(0, 0, 0, 0.4);
      z-index: 999;
      display: none;
    }
    #mobileMenuBtn { display: none; }

    /* 모바일 반응형 스타일 */
    @media (max-width: 768px) {
      header {
        padding: 12px 16px;
      }
      header h1 {
        font-size: 18px;
      }
      .pill {
        display: none;
      }
      #mobileMenuBtn {
        display: inline-flex;
        margin-left: auto;
        background: none;
        border: none;
        padding: 4px;
        border-radius: 99px;
      }
      #main {
        grid-template-columns: 1fr;
        grid-template-rows: 1fr;
      }
      #sidebar {
        position: fixed;
        top: 0;
        left: 0;
        height: 100%;
        width: 90%;
        max-width: 340px;
        z-index: 1000;
        box-shadow: var(--shadow-md);
        transform: translateX(-100%);
        border-right: 1px solid var(--border-color);
      }
      #sidebar.is-open {
        transform: translateX(0);
      }
    }
  </style>
</head>
<body>
  <div id="loader" style="display: none;"><div class="spinner"></div></div>
  <div id="backdrop"></div>

  <header>
    <h1>🗺️ 데이터 지도 시각화 도구</h1>
    <span class="pill" id="countPill">데이터: 0개</span>
    <span class="pill" id="verPill"></span>
    <button id="mobileMenuBtn" aria-label="설정 메뉴 열기">
        <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="3" y1="12" x2="21" y2="12"></line><line x1="3" y1="6" x2="21" y2="6"></line><line x1="3" y1="18" x2="21" y2="18"></line></svg>
    </button>
  </header>

  <div id="debugBanner" style="display:none;padding:10px 16px;background:#fee2e2;color:#991b1b;border-bottom:1px solid #fecaca;font-size:14px; display:flex; align-items:center; justify-content:space-between;">
    <span>지도 초기화에 실패했습니다. API 키와 설정을 확인해주세요.</span> <button id="dbgToggle">상세 보기</button>
  </div>
  <div id="debugPanel" style="display:none;padding:12px 16px;border-bottom:1px solid #eee;font-size:12px;line-height:1.6; background: #fff8f8;">
    <div><b>현재 Origin:</b> <span id="dbgOrigin"></span></div>
    <div><b>오류 로그:</b></div>
    <pre id="dbgLog" style="white-space:pre-wrap;background:#fafafa;border:1px solid #eee;padding:8px;border-radius:6px;max-height:160px;overflow:auto"></pre>
    <div><b>체크리스트</b></div>
    <ul style="margin:6px 0 0 18px; padding-left: 0;">
      <li>API 키에 오타가 없나요? (공백 포함 X)</li>
      <li>'Maps JavaScript API'를 사용 설정했나요?</li>
      <li>프로젝트에 결제 계정이 연결되어 있나요?</li>
      <li>HTTP 리퍼러 제한에 현재 주소(<code id="dbgRef"></code>)를 추가했나요?</li>
    </ul>
  </div>

  <div id="main">
    <aside id="sidebar">
      <details open>
        <summary>⚙️ 데이터 & 필터</summary>
        <div class="details-content">
          <div style="margin-bottom: 16px;">
            <label for="sheetUrl">데이터 URL (공개 CSV)</label>
            <input id="sheetUrl" type="url" placeholder="Google Sheets '웹에 게시' URL 입력" />
          </div>
          <div style="display:flex; gap:8px; margin-bottom: 24px;">
            <button id="loadBtn" style="flex:1;">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 15v4a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2v-4"/><polyline points="7 10 12 15 17 10"/><line x1="12" x2="12" y1="15" y2="3"/></svg>
              불러오기
            </button>
            <button id="demoBtn" type="button">
              <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17.5 19H9a7 7 0 1 1 6.71-9h1.79a4.5 4.5 0 1 1 0 9Z"/></svg>
              기본정보
            </button>
          </div>

          <div style="margin-bottom: 12px;"><label for="fName">이름 필터</label><input id="fName" type="text" placeholder="예: 서울, 부산" /></div>
          <div class="row" style="margin-bottom: 12px;">
            <div><label for="fMin">Count 최소값</label><input id="fMin" type="number" placeholder="최소" /></div>
            <div><label for="fMax">Count 최대값</label><input id="fMax" type="number" placeholder="최대" /></div>
          </div>
          <label style="display:flex; align-items:center; gap: 8px; user-select:none; margin-bottom: 16px;"><input id="fHideNaN" type="checkbox" /> `count` 없는 행 숨기기</label>
          <button id="applyFilter" style="width: 100%;">필터 적용</button>
        </div>
      </details>

      <details open>
        <summary>🎨 강도(Count) 색상</summary>
        <div class="details-content">
            <div class="row" style="margin-bottom: 12px;">
            <div>
                <label for="thresholds">경계값 (쉼표 구분)</label>
                <input id="thresholds" type="text" value="100,500,1000,2000" />
            </div>
            <div>
                <label for="palette">색상 팔레트</label>
                <select id="palette">
                  <option value="spectral">Spectral</option>
                  <option value="viridis">Viridis</option>
                  <option value="blues">Blues</option>
                  <option value="reds">Reds</option>
                </select>
            </div>
            </div>
            <label style="display:flex; align-items:center; gap: 8px; user-select:none;"><input id="enableDensity" type="checkbox" checked /> `count` 값에 따라 색상 적용</label>
            <div id="legendBox" style="margin-top:16px;"></div>
        </div>
      </details>

      <details open>
        <summary>📊 집계</summary>
        <div class="details-content">
            <div id="stats">집계 정보가 여기에 표시됩니다.</div>
        </div>
      </details>
    </aside>

    <div id="map" role="region" aria-label="영업망 지도"></div>
  </div>

  <script>
    // 전역 변수
    let map, infoWindow, circles = [], lastItems = [];

    // 기본 설정
    const DEFAULT_CENTER = { lat: 36.5, lng: 127.8 };
    const DEFAULT_ZOOM = 7;
    const APP_VERSION = 'v2.2.0';
    const BUILD_DATE = '2025-09-07';

    // 유틸리티 함수들
    function escapeHtml(s) {
      return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\"/g,'&quot;').replace(/'/g,'&#039;');
    }
    function coerceNumber(v) {
      if (v == null) return NaN;
      if (typeof v === 'number') return v;
      const n = parseFloat(String(v).replace(/,/g, ''));
      return isNaN(n) ? NaN : n;
    }
    function pickColor(i) {
      const colors = ['#4f46e5', '#16a34a', '#f59e0b', '#ef4444', '#8b5cf6', '#0ea5e9', '#22c55e', '#d946ef'];
      return colors[i % colors.length];
    }

    // CSV 파서
    function parseCSV(text) {
        const rows = [];
        let i = 0, cur = '', row = [], inQuotes = false;
        text = text.replace(/\r\n/g, '\n').replace(/\r/g, '\n');
        while (i < text.length) {
            const ch = text[i];
            if (inQuotes) {
                if (ch === '"') {
                    if (text[i + 1] === '"') { cur += '"'; i++; } else { inQuotes = false; }
                } else { cur += ch; }
            } else {
                if (ch === '"') { inQuotes = true; }
                else if (ch === ',') { row.push(cur.trim()); cur = ''; }
                else if (ch === '\n') {
                    if (cur !== '' || row.length) {
                        row.push(cur.trim());
                        rows.push(row);
                        row = []; cur = '';
                    }
                } else { cur += ch; }
            }
            i++;
        }
        if (cur !== '' || row.length) { row.push(cur.trim()); rows.push(row); }
        if (!rows.length) throw new Error('CSV 내용이 비어있습니다.');
        const header = rows.shift().map(h => h.trim());
        return { cols: header, rows };
    }

    // gviz 파서
    function parseGviz(raw) {
      const s = raw.indexOf('(');
      const e = raw.lastIndexOf(')');
      if (s === -1 || e === -1) throw new Error('gviz 응답 형식 오류');
      const obj = JSON.parse(raw.slice(s + 1, e));
      const cols = obj.table.cols.map(c => c.label || c.id || '');
      const rows = obj.table.rows.map(r => r.c.map(c => c ? c.v : ''));
      return { cols, rows };
    }

    function getThresholds() {
      return (document.getElementById('thresholds').value || '')
        .split(',')
        .map(s => parseFloat(s.trim()))
        .filter(n => Number.isFinite(n))
        .sort((a, b) => a - b);
    }

    function getBin(v, ths) {
      for (let i = 0; i < ths.length; i++) {
        if (v < ths[i]) return i;
      }
      return ths.length;
    }

    function getPalette(n) {
      const maps = {
        spectral: ['#d53e4f', '#fc8d59', '#fee08b', '#e6f598', '#99d594', '#3288bd'],
        viridis: ['#440154', '#414487', '#2a788e', '#22a884', '#7ad151', '#fde725'],
        blues: ['#eff3ff', '#bdd7e7', '#6baed6', '#3182bd', '#08519c'],
        reds: ['#fee5d9', '#fcae91', '#fb6a4a', '#de2d26', '#a50f15']
      };
      const key = document.getElementById('palette').value || 'spectral';
      const base = maps[key];
      if (n <= base.length) return base.slice(0, n).reverse();
      const out = [];
      for (let i = 0; i < n; i++) {
        const idx = Math.round(i * (base.length - 1) / (n - 1));
        out.push(base[idx]);
      }
      return out.reverse();
    }

    function initMap() {
      document.getElementById('debugBanner').style.display = 'none';
      try {
        map = new google.maps.Map(document.getElementById('map'), {
          center: DEFAULT_CENTER,
          zoom: DEFAULT_ZOOM,
          mapTypeControl: false,
          streetViewControl: false,
          fullscreenControl: false,
        });
        infoWindow = new google.maps.InfoWindow();

        // Register event listeners
        document.getElementById('loadBtn').addEventListener('click', loadAll);
        document.getElementById('demoBtn').addEventListener('click', loadDemoData);
        document.getElementById('applyFilter').addEventListener('click', () => {
          renderCircles(filterItems(lastItems));
        });
        ['thresholds', 'palette', 'enableDensity'].forEach(id => {
          document.getElementById(id).addEventListener('change', () => {
            renderCircles(filterItems(lastItems));
          });
        });

        // Mobile sidebar controls
        const mobileMenuBtn = document.getElementById('mobileMenuBtn');
        const sidebar = document.getElementById('sidebar');
        const backdrop = document.getElementById('backdrop');

        function openSidebar() {
            backdrop.style.display = 'block';
            sidebar.classList.add('is-open');
        }
        function closeSidebar() {
            backdrop.style.display = 'none';
            sidebar.classList.remove('is-open');
        }

        mobileMenuBtn.addEventListener('click', openSidebar);
        backdrop.addEventListener('click', closeSidebar);

        // Initial data load
        loadDemoData();

      } catch (e) {
        console.error('지도 초기화 오류:', e);
        document.getElementById('debugBanner').style.display = 'flex';
        throw e;
      }
    }

    async function loadAll() {
      const loader = document.getElementById('loader');
      loader.style.display = 'flex';
      try {
        const items = await loadPointItems();
        lastItems = items;
        renderCircles(filterItems(items));
      } catch (e) {
        console.error(e);
        alert('데이터 불러오기 실패: ' + (e?.message || e));
      } finally {
        loader.style.display = 'none';
      }
    }

    function loadDemoData() {
      const demoUrl = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vSABTR_GejswwZyPLMzuiVhmW_0QFCqUceshwtpXde8c3dcI_Oww7l4zlkhHSTR8GN4rEJcHEl9jD7k/pub?output=csv';
      document.getElementById('sheetUrl').value = demoUrl;
      loadAll();
    }

    async function loadPointItems() {
      const url = document.getElementById('sheetUrl').value.trim();
      if (!url) throw new Error('데이터 URL을 입력하세요');

      const text = await (await fetch(url)).text();
      const table = url.includes('/gviz/tq') ? parseGviz(text) : parseCSV(text);
      return processTableData(table);
    }

    function processTableData(table) {
      const idx = {};
      const names = table.cols.map(c => String(c).trim().toLowerCase());
      ['name', 'lat', 'lng', 'radius_km', 'count', 'color', 'stroke_color', 'stroke_opacity', 'fill_opacity', 'note']
        .forEach(k => idx[k] = names.indexOf(k));
      return table.rows.map((r, i) => ({
          name: idx.name >= 0 ? r[idx.name] : `지점 ${i + 1}`,
          lat: coerceNumber(r[idx.lat]),
          lng: coerceNumber(r[idx.lng]),
          radius_km: coerceNumber(r[idx.radius_km]),
          count: idx.count >= 0 ? coerceNumber(r[idx.count]) : NaN,
          color: (idx.color >= 0 && r[idx.color]) ? r[idx.color] : pickColor(i),
          strokeColor: (idx.stroke_color >= 0 && r[idx.stroke_color]) ? r[idx.stroke_color] : pickColor(i),
          strokeOpacity: (idx.stroke_opacity >= 0 && r[idx.stroke_opacity]) ? Number(r[idx.stroke_opacity]) : 0.9,
          fillOpacity: (idx.fill_opacity >= 0 && r[idx.fill_opacity]) ? Number(r[idx.fill_opacity]) : 0.35,
          note: (idx.note >= 0 && r[idx.note]) ? r[idx.note] : ''
        })).filter(it => Number.isFinite(it.lat) && Number.isFinite(it.lng) && Number.isFinite(it.radius_km));
    }

    function filterItems(items) {
      if (!items || !items.length) return [];
      const q = (document.getElementById('fName').value || '').trim().toLowerCase();
      const min = parseFloat(document.getElementById('fMin').value);
      const max = parseFloat(document.getElementById('fMax').value);
      const hideNaN = document.getElementById('fHideNaN').checked;
      return items.filter(it => {
        if (q && !it.name.toLowerCase().includes(q)) return false;
        if (Number.isFinite(min) && !(Number.isFinite(it.count) && it.count >= min)) return false;
        if (Number.isFinite(max) && !(Number.isFinite(it.count) && it.count <= max)) return false;
        if (hideNaN && !Number.isFinite(it.count)) return false;
        return true;
      });
    }

    function renderCircles(items) {
      circles.forEach(c => c.setMap(null));
      circles = [];
      const bounds = new google.maps.LatLngBounds();
      const ths = getThresholds();
      const pal = getPalette(ths.length + 1);
      const densityOn = document.getElementById('enableDensity').checked;

      items.forEach((it) => {
        const center = { lat: it.lat, lng: it.lng };
        const isCountFinite = Number.isFinite(it.count);
        const fillColor = (densityOn && isCountFinite) ? pal[getBin(it.count, ths)] : it.color;
        const strokeColor = (densityOn && isCountFinite) ? fillColor : it.strokeColor;
        const circle = new google.maps.Circle({
          map, center, radius: it.radius_km * 1000,
          strokeColor, strokeOpacity: it.strokeOpacity, strokeWeight: 2,
          fillColor, fillOpacity: it.fillOpacity
        });
        circles.push(circle);
        bounds.extend(center);
        circle.addListener('click', () => {
          const html = `<div style="min-width:260px; font-size:14px; line-height:1.6;">
            <div style="font-weight:700;margin-bottom:6px; font-size:16px;">${escapeHtml(it.name)}</div>
            <div><b>위치:</b> ${it.lat.toFixed(4)}, ${it.lng.toFixed(4)}</div>
            <div><b>반경:</b> ${it.radius_km} km</div>
            ${isCountFinite ? `<div><b>도입 구좌수(count):</b> ${it.count.toLocaleString()}</div>` : ''}
            ${it.note ? `<div style="margin-top:8px; padding-top:8px; border-top:1px solid #eee;">${escapeHtml(it.note)}</div>` : ''}
          </div>`;
          infoWindow.setContent(html);
          infoWindow.setPosition(center);
          infoWindow.open({ map });
        });
      });

      if (items.length > 0 && !bounds.isEmpty()) map.fitBounds(bounds);

      document.getElementById('countPill').textContent = `데이터: ${items.length}개`;
      renderLegend(ths, pal);
      renderStats(items, ths);
    }

    function renderLegend(ths, pal) {
      const el = document.getElementById('legendBox');
      if (!document.getElementById('enableDensity').checked) {
        el.innerHTML = '';
        return;
      }
      const blocks = [];
      if (ths.length === 0) {
        blocks.push({ label: '모든 값', color: pal[0] || '#cccccc' });
      } else {
        for (let i = 0; i <= ths.length; i++) {
          let label = '';
          if (i === 0) label = `< ${ths[0].toLocaleString()}`;
          else if (i === ths.length) label = `≥ ${ths[i - 1].toLocaleString()}`;
          else label = `${ths[i - 1].toLocaleString()} – ${ths[i] - 1}`;
          blocks.push({ label, color: pal[i] });
        }
      }
      el.innerHTML = '<div class="legend"><h3>강도 스케일 (Count)</h3>' +
        blocks.map(b => `<div style="display:flex;align-items:center;gap:8px;margin:6px 0">
          <span style="display:inline-block;width:16px;height:16px;border-radius:4px;background:${b.color};border:1px solid rgba(0,0,0,.2)"></span>
          <span>${b.label}</span>
        </div>`).join('') + '</div>';
    }

    function renderStats(items, ths) {
      const el = document.getElementById('stats');
      const total = items.length;
      const sum = items.reduce((a, b) => a + (Number.isFinite(b.count) ? b.count : 0), 0);
      const bins = new Array(ths.length + 1).fill(0);
      items.forEach(it => {
        if (Number.isFinite(it.count)) bins[getBin(it.count, ths)]++;
      });

      let html = `<div class="stat"><span>총 지점 수</span><b>${total.toLocaleString()}</b></div>
                  <div class="stat"><span>Count 합계</span><b>${sum.toLocaleString()}</b></div>`;

      if (document.getElementById('enableDensity').checked && ths.length > 0) {
          html += '<div style="height:10px;"></div>';
          for (let i = 0; i < bins.length; i++) {
              let label = '';
              if (i === 0) label = `< ${ths[0].toLocaleString()}`;
              else if (i === bins.length - 1) label = `≥ ${ths[i - 1].toLocaleString()}`;
              else label = `${ths[i - 1].toLocaleString()} – ${ths[i] - 1}`;
              html += `<div class="stat"><span>${label}</span><b>${bins[i].toLocaleString()}</b></div>`;
          }
      }
      el.innerHTML = html;
    }

    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('verPill').textContent = `v${APP_VERSION}`;
    });

    window.initMap = initMap;
  </script>

  <script>
    // 디버그 스크립트
    (function() {
      const banner = document.getElementById('debugBanner');
      const panel = document.getElementById('debugPanel');
      const logEl = document.getElementById('dbgLog');
      if (document.getElementById('dbgOrigin')) document.getElementById('dbgOrigin').textContent = location.origin;
      if (document.getElementById('dbgRef')) document.getElementById('dbgRef').textContent = location.origin.replace(/\/$/, '') + '/*';

      let inited = false;
      const oldInit = window.initMap;
      window.initMap = function() { inited = true; if (oldInit) oldInit(); };

      setTimeout(() => {
        if (!inited) {
            if (banner) banner.style.display = 'flex';
        }
      }, 15000);

      document.getElementById('dbgToggle').addEventListener('click', () => {
        if (panel) panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
      });

      const log = (m) => { if (logEl) logEl.textContent += (m + '\n'); };
      window.addEventListener('error', e => { log('[Error] ' + (e.message || e.type)); if (banner) banner.style.display = 'flex'; });
      window.addEventListener('unhandledrejection', e => { log('[Promise] ' + (e.reason && e.reason.message)); if (banner) banner.style.display = 'flex'; });
    })();
  </script>

  <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCJKF6l-C4shNQbO99oImE6D_69JL7ZnnE&callback=initMap&libraries=maps,marker&v=weekly"></script>
</body>
</html>

