<!doctype html>
<html lang="ko">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>🗺️</text></svg>">
  <title>Sales Network Map</title>
  <style>
    :root {
      --color-primary: #4f46e5;
      --color-primary-hover: #4338ca;
      --border-color: #e5e7eb;
      --background-light: #f9fafb;
      --text-main: #111827;
      --text-muted: #6b7280;
      --shadow: 0 1px 3px 0 rgba(0, 0, 0, 0.1), 0 1px 2px -1px rgba(0, 0, 0, 0.1);
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -2px rgba(0, 0, 0, 0.1);
      --radius: 8px;
    }
    html, body { 
      height: 100%; 
      margin: 0; 
      font-family: 'Pretendard', system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans KR", Arial, sans-serif;
      background-color: #f9fafb;
      color: var(--text-main);
    }
    header { 
      padding: 12px 20px; 
      border-bottom: 1px solid var(--border-color); 
      display: flex; 
      gap: 16px; 
      align-items: center;
      background-color: #fff;
      box-shadow: var(--shadow);
      z-index: 10;
      position: relative;
    }
    header h1 { 
      font-size: 20px; 
      margin: 0; 
      font-weight: 700;
    }
    #main { 
      display: grid; 
      grid-template-columns: 340px 1fr; 
      height: calc(100% - 65px); 
    }
    #sidebar { 
      border-right: 1px solid var(--border-color); 
      padding: 16px; 
      overflow-y: auto; 
      background-color: #fff;
    }
    #map { height: 100%; }
    
    .pill { 
      display: inline-block; 
      padding: 4px 12px; 
      border-radius: 999px; 
      border: 1px solid var(--border-color); 
      background: var(--background-light);
      font-size: 13px;
      font-weight: 500;
    }
    
    input, select, button, textarea { 
      font: inherit; 
      transition: all 0.2s ease;
    }
    input[type="text"], input[type="url"], input[type="number"], input[type="password"], textarea, select { 
      width: 100%; 
      padding: 8px 12px; 
      border-radius: var(--radius); 
      border: 1px solid var(--border-color); 
      box-sizing: border-box;
      background-color: #fff;
    }
    input:focus, select:focus, textarea:focus {
      outline: 2px solid transparent;
      outline-offset: 2px;
      border-color: var(--color-primary);
      box-shadow: 0 0 0 2px rgba(79, 70, 229, 0.3);
    }
    
    button { 
      padding: 8px 14px; 
      border-radius: var(--radius); 
      border: 1px solid var(--border-color); 
      background: #fff; 
      cursor: pointer; 
      font-weight: 600;
    }
    button:hover { 
      background: var(--background-light);
      border-color: #d1d5db;
    }
    button#loadBtn {
      background-color: var(--color-primary);
      color: #fff;
      border-color: var(--color-primary);
    }
    button#loadBtn:hover {
      background-color: var(--color-primary-hover);
    }
    
    details { 
      background: #fff; 
      border: 1px solid var(--border-color); 
      border-radius: var(--radius); 
      margin-bottom: 16px;
      overflow: hidden;
    }
    details[open] summary {
      border-bottom: 1px solid var(--border-color);
    }
    summary { 
      cursor: pointer;
      padding: 12px 14px;
      font-weight: 600;
      font-size: 15px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    summary::marker { content: ''; }
    summary:before {
      content: '▶';
      font-size: 0.7em;
      transition: transform 0.2s;
      margin-right: 4px;
    }
    details[open] > summary:before {
      transform: rotate(90deg);
    }
    .details-content {
      padding: 16px;
    }

    .legend { background: #fff; padding: 12px; border-radius: var(--radius); box-shadow: var(--shadow-md); font-size: 13px; }
    .legend h3 { margin: 0 0 8px; font-size: 13px; font-weight: 700; }
    
    label { display: block; margin-bottom: 6px; font-size: 14px; font-weight: 500; }
    .row { display: grid; grid-template-columns: 1fr 1fr; gap: 12px; }
    .mb8 { margin-bottom: 8px; }
    .mb12 { margin-bottom: 12px; }
    .mb16 { margin-bottom: 16px; }
    .muted { color: var(--text-muted); font-size: 12px; }
    .stat { display:flex; justify-content: space-between; margin: 8px 0; font-size: 14px; padding-bottom: 8px; border-bottom: 1px dashed var(--border-color); }
    .stat:last-child { border-bottom: 0; }
  </style>
</head>
<body>
  <header>
    <h1>🗺️ 영업망 지도</h1>
    <span class="pill" id="countPill">데이터: 0개</span>
    <span class="pill" id="verPill"></span>
  </header>

  <div id="debugBanner" style="display:none;padding:10px 16px;background:#fee2e2;color:#991b1b;border-bottom:1px solid #fecaca;font-size:14px; display:flex; align-items:center; justify-content:space-between;">
    <span>지도 초기화에 실패했습니다. API 키와 설정을 확인해주세요.</span> <button id="dbgToggle">상세 보기</button>
  </div>
  <div id="debugPanel" style="display:none;padding:12px 16px;border-bottom:1px solid #eee;font-size:12px;line-height:1.6; background: #fff8f8;">
    <div><b>현재 Origin:</b> <span id="dbgOrigin"></span></div>
    <div><b>오류 로그:</b></div>
    <pre id="dbgLog" style="white-space:pre-wrap;background:#fafafa;border:1px solid #eee;padding:8px;border-radius:6px;max-height:160px;overflow:auto"></pre>
    <div><b>체크리스트</b></div>
    <ul style="margin:6px 0 0 18px; padding-left: 0;">
      <li>키 오타 여부 (공백/따옴표 포함 X)</li>
      <li>Maps JavaScript API <u>사용 설정</u> 여부</li>
      <li>결제 계정 연결 여부 (월 $200 무료 크레딧)</li>
      <li>HTTP referrer 제한에 <code id="dbgRef"></code> 또는 <code id="dbgRef2"></code> 추가</li>
      <li>광고/추적 차단 확장프로그램 일시 비활성화</li>
      <li>HTTPS로 접속, 혼합콘텐츠 차단 여부 확인</li>
    </ul>
  </div>

  <div id="main">
    <aside id="sidebar">
      <details open>
        <summary>📂 데이터 소스</summary>
        <div class="details-content">
          <div class="mb16">
            <label for="mode">모드</label>
            <select id="mode">
              <option value="url">A) 공개 CSV / gviz JSON URL</option>
              <option value="sheets">B) Google Sheets API</option>
            </select>
          </div>
          <div id="mode-url" class="mb12">
            <label for="sheetUrl">시트 공개 URL</label>
            <input id="sheetUrl" type="url" placeholder="예: .../pub?output=csv" />
          </div>
          <div id="mode-sheets" class="mb12" style="display:none">
            <div class="mb8"><label for="sheetId">시트 ID</label><input id="sheetId" type="text" placeholder="문서 URL의 /d/와 /edit 사이 ID" /></div>
            <div class="mb8"><label for="sheetRange">범위</label><input id="sheetRange" type="text" placeholder="예: Sheet1!A1:J999" /></div>
            <div class="mb8"><label for="sheetsApiKey">Google API Key</label><input id="sheetsApiKey" type="password" placeholder="브라우저 노출 주의: 도메인 제한 권장" /></div>
            <div class="muted">※ 시트가 비공개면 클라이언트에서 접근 불가합니다.</div>
          </div>
          <div class="mb16"><label for="geojsonUrl">GeoJSON URL (선택)</label><input id="geojsonUrl" type="url" placeholder="권역 폴리곤 GeoJSON 주소" /></div>
          <div class="row mb8">
            <div><label for="refreshSec">자동 새로고침(초)</label><input id="refreshSec" type="number" min="0" value="0" /></div>
            <div><label>&nbsp;</label><div style="display:flex;gap:6px"><button id="loadBtn">불러오기</button><button id="demoBtn" type="button">데모</button></div></div>
          </div>
        </div>
      </details>

      <details open>
        <summary>🎨 강도(Count) 색상</summary>
        <div class="details-content">
            <div class="row mb12">
            <div>
                <label for="thresholds">경계값 (쉼표 구분)</label>
                <input id="thresholds" type="text" value="100,500,1000,2000" />
            </div>
            <div>
                <label for="palette">팔레트</label>
                <select id="palette">
                <option value="spectral">Spectral</option>
                <option value="viridis">Viridis</option>
                <option value="blues">Blues</option>
                <option value="reds">Reds</option>
                </select>
            </div>
            </div>
            <label style="display:flex; align-items:center; gap: 8px; user-select:none;"><input id="enableDensity" type="checkbox" checked /> `count` 값에 따라 색상 적용</label>
            <div id="legendBox" class="mb8" style="margin-top:16px;"></div>
        </div>
      </details>

      <details open>
        <summary>🔍 필터</summary>
        <div class="details-content">
            <div class="mb12"><label for="fName">이름 포함</label><input id="fName" type="text" placeholder="예: 서울, 부산" /></div>
            <div class="row mb12">
            <div><label for="fMin">count ≥</label><input id="fMin" type="number" placeholder="최소" /></div>
            <div><label for="fMax">count ≤</label><input id="fMax" type="number" placeholder="최대" /></div>
            </div>
            <label class="mb16" style="display:flex; align-items:center; gap: 8px; user-select:none;"><input id="fHideNaN" type="checkbox" /> `count` 없는 행 숨기기</label>
            <button id="applyFilter">필터 적용</button>
        </div>
      </details>

      <details open>
        <summary>📊 집계</summary>
        <div class="details-content">
            <div id="stats"></div>
        </div>
      </details>
    </aside>

    <div id="map" role="region" aria-label="영업망 지도"></div>
  </div>
  
  <script>
    // All previous JavaScript code remains the same...
    // ...
    // (이전의 모든 JavaScript 코드는 그대로 유지됩니다)
  </script>
  
  <script>
    // Debug script remains the same...
    // ...
  </script>

  <script async defer src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCJKF6l-C4shNQbO99oImE6D_69JL7ZnnE&callback=initMap&libraries=maps,marker&v=weekly"></script>
</body>
</html>
